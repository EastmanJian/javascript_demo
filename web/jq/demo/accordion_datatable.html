<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/v/dt/jq-3.2.1/jq-3.2.1/dt-1.10.16/datatables.min.css"/>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script type="text/javascript"
            src="https://cdn.datatables.net/v/dt/jq-3.2.1/jq-3.2.1/dt-1.10.16/datatables.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        /**
         * Escape HTML special characters, returns the escaped HTML string.
         * @param string
         * @returns {string}
         */
        function escapeHTML( string )
        {
            var pre = document.createElement('pre');
            var text = document.createTextNode( string );
            pre.appendChild(text);
            return pre.innerHTML;
        }


        $(document).ready(function () {
            //load json data
            console.log(location.origin);
            if (location.origin.search("localhost") != -1) {
                $.getJSON("demo_list.json", renderDemoList);
            } else {
                $.getJSON("//eastmanjian.cn/js_demo/jq/demo/demo_list.json", renderDemoList);
            }
        });

        //use the combination of jQueryUI accordion widget and datatables plugin to render the UI
        function renderDemoList(result) {
            //add each prototype section
            for (var i = 0; i < result.prototypes.length; i++) {
                var html = "<div><h3>" + result.prototypes[i].tech + "</h3><div><table id='tech" + i
                    + "PrototypeList' class='display compact' cellspacing='0' width='100%'></table></div></div>";
                $("#prototypes").append(html);
            }

            //add an overall section with all prototypes data
            var html = "<div><h3>All Prototypes</h3><div><table id='allPrototypes' "
                + "class='display compact' cellspacing='0' width='100%'></table></div></div>";
            $("#prototypes").append(html);

            //render accordion
            $("#prototypes").accordion({
                header: "> div > h3",
                heightStyle: "content",
                collapsible: true,
                //save the activated panel to local storage
                activate: function (event, ui) {
                    console.log("Panel moves to " + $(this).accordion("option", "active") + ". Saved to localStorage.");
                    localStorage.activatedPanel = $(this).accordion("option", "active");
                },
                //load the activated panel last time when it's saved
                create:  function (event, ui) {
                    if (localStorage.activatedPanel) {
                        console.log("The active panel last time is " + localStorage.activatedPanel + ".");
                        $(this).accordion("option", "active", Number(localStorage.activatedPanel));
                    }
                }
            }).sortable({ //make accordion sortable with drag and drop
                axis: "y",
                handle: "h3",
                stop: function (event, ui) {
                    // IE doesn't register the blur when sorting
                    // so trigger focusout handlers to remove .ui-state-focus
                    ui.item.children("h3").triggerHandler("focusout");

                    // Refresh accordion to handle new order
                    $(this).accordion("refresh");
                }
            });

            //construct table data arrays from the source json
            var tableData = [];
            var link;
            for (var i = 0; i < result.prototypes.length; i++) {
                tableData[i] = [];
                for (var j = 0; j < result.prototypes[i].list.length; j++) {
                    tableData[i][j] = [];
                    tableData[i][j][0] = result.prototypes[i].list[j][0];
                    link = result.prototypes[i].list[j][2];
                    if (result.prototypes[i].list[j][3] == "TIY") {
                        //using TIY function to show the prototype
                        link = "https://eastmanjian.cn/js_demo/tiy.jsp?sample=" + encodeURIComponent(link);
                        link = link.replace("sample=https%3A%2F%2Feastmanjian.cn%2Fjs_demo%2F", "sample=");
                    }
                    //construct the 'a' tag
                    tableData[i][j][1] = '<A HREF="' + link + '">' + escapeHTML(result.prototypes[i].list[j][1]) + '</A>';
                }
            }
            console.log(tableData);


            //render datatables for each prototype section
            for (var i = 0; i < result.prototypes.length; i++) {
                $('#tech' + i + 'PrototypeList').DataTable({
                    data: tableData[i],
                    columns: [
                        {title: "Category",  "orderable": false},
                        {title: "Example"}
                    ],
                    initComplete: function () { //generate column filter
                        var column = this.api().column(0);

                        var select = $('<select class="columnSelect"><option value="All Categories">All Categories</option></select>')
                            .appendTo($(column.header()).empty())
                            .on('change', function () {
                                var val = $.fn.dataTable.util.escapeRegex($(this).val());
                                column
                                    .search(val == "All Categories" ? '' : '^' + val + '$', true, false)
                                    .draw();
                            });

                        column.data().unique().sort().each(function (d, j) {
                            select.append('<option value="' + d + '">' + d + '</option>')
                        });
                    }
                });
            }


            //construct the all prototype data array
            var allPrototypeList = [];
            var tempList;
            for (var i = 0; i < result.prototypes.length; i++) {
                tempList = [];
                for (var j = 0; j < tableData[i].length; j++) {
                    tempList[j] = tableData[i][j].slice(); //clone the array
                }
                for (var j = 0; j < tempList.length; j++) { //add technology column as the 1st column
                    tempList[j].unshift(result.prototypes[i].tech);
                }
                allPrototypeList = allPrototypeList.concat(tempList);
            }

            //render datatables for all-prototype section
            $('#allPrototypes').DataTable({
                data: allPrototypeList,
                columns: [
                    {title: "Technology", "orderable": false},
                    {title: "Category", "orderable": false},
                    {title: "Example"}
                ],
                initComplete: function () { //generate column filters
                    //Technology column filter
                    var column0 = this.api().column(0);
                    var select = $('<select class="columnSelect"><option value="All Technologies">All Technologies</option></select>')
                        .appendTo($(column0.header()).empty())
                        .on('change', function () {
                            var val = $.fn.dataTable.util.escapeRegex($(this).val());
                            column0
                                .search(val == "All Technologies" ? '' : '^' + val + '$', true, false)
                                .draw();
                        });
                    column0.data().unique().sort().each(function (d, j) {
                        select.append('<option value="' + d + '">' + d + '</option>')
                    });

                    //Category column filter
                    var column1 = this.api().column(1);
                    var select = $('<select class="columnSelect"><option value="All Categories">All Categories</option></select>')
                        .appendTo($(column1.header()).empty())
                        .on('change', function () {
                            var val = $.fn.dataTable.util.escapeRegex($(this).val());
                            column1
                                .search(val == "All Categories" ? '' : '^' + val + '$', true, false)
                                .draw();
                        });
                    column1.data().unique().sort().each(function (d, j) {
                        select.append('<option value="' + d + '">' + d + '</option>')
                    });
                }
            });

        }

    </script>
</head>
<body>
<h3>jQuery UI Accordion, datatable plugin, jQuery AJAX read json data</h3>
<section id="prototypes">

</section>
</body>
</html>
